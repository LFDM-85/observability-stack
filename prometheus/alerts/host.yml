groups:
  - name: host_alerts
    interval: 30s
    rules:
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Instância {{ $labels.instance }} está down"
          description: "A instância {{ $labels.instance }} do job {{ $labels.job }} está inacessível há mais de 1 minuto."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostCpuHighUsageWarning
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Uso de CPU elevado (Warning) em {{ $labels.instance }}"
          description: "CPU está acima de 80% (atual: {{ $value | printf \"%.1f\" }}%) na instância {{ $labels.instance }} há mais de 5 minutos."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostCpuHighUsageCritical
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Uso de CPU Crítico em {{ $labels.instance }}"
          description: "CPU está acima de 95% (atual: {{ $value | printf \"%.1f\" }}%) na instância {{ $labels.instance }}!"
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostMemoryHighUsageWarning
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Uso de Memória elevado (Warning) em {{ $labels.instance }}"
          description: "Memória está acima de 80% (atual: {{ $value | printf \"%.1f\" }}%) na instância {{ $labels.instance }} há mais de 5 minutos."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostMemoryHighUsageCritical
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Uso de Memória Crítico em {{ $labels.instance }}"
          description: "Memória está acima de 95% (atual: {{ $value | printf \"%.1f\" }}%) na instância {{ $labels.instance }}!"
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostDiskSpaceWarning
        expr: ((node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 15 or predict_linear(node_filesystem_avail_bytes{fstype!~"tmpfs"}[1h], 24 * 3600) < 0) and ON (instance, device, mountpoint) node_filesystem_readonly == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pouco espaço em disco (Warning) em {{ $labels.instance }}"
          description: "O disco {{ $labels.mountpoint }} tem menos de 15% livre ou prevê-se que encha em 24h na instância {{ $labels.instance }}."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostDiskSpaceCritical
        expr: ((node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 5 or predict_linear(node_filesystem_avail_bytes{fstype!~"tmpfs"}[1h], 6 * 3600) < 0) and ON (instance, device, mountpoint) node_filesystem_readonly == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Pouco espaço em disco Crítico em {{ $labels.instance }}"
          description: "O disco {{ $labels.mountpoint }} tem menos de 5% livre ou prevê-se que encha em 6h na instância {{ $labels.instance }}!"
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostHighLoad
        expr: node_load1 / count by(instance) (node_cpu_seconds_total{mode="idle"}) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Load Average elevado em {{ $labels.instance }}"
          description: "Load Average (1m) é 2x maior que o número de cores na instância {{ $labels.instance }}."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      # Network Alerts
      - alert: HostNetworkReceiveErrors
        expr: rate(node_network_receive_errs_total[2m]) / rate(node_network_receive_packets_total[2m]) > 0.01
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Erros de rede (Receive) em {{ $labels.instance }}"
          description: "Interface {{ $labels.device }} tem taxa de erros de recepção > 1%."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostNetworkTransmitErrors
        expr: rate(node_network_transmit_errs_total[2m]) / rate(node_network_transmit_packets_total[2m]) > 0.01
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Erros de rede (Transmit) em {{ $labels.instance }}"
          description: "Interface {{ $labels.device }} tem taxa de erros de transmissão > 1%."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostHighIOWait
        expr: avg by (instance) (rate(node_cpu_seconds_total{mode="iowait"}[5m])) * 100 > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "I/O Wait elevado em {{ $labels.instance }}"
          description: "O sistema está gastando muito tempo aguardando I/O de disco ({{ $value | printf \"%.1f\" }}%)."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostOOMKill
        expr: increase(node_vmstat_oom_kill[5m]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "OOM Kill detectado em {{ $labels.instance }}"
          description: "O kernel encerrou processos devido à falta de memória na instância {{ $labels.instance }}."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"

      - alert: HostTcpConnectionsHigh
        expr: node_netstat_Tcp_CurrEstab > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Número elevado de conexões TCP em {{ $labels.instance }}"
          description: "A instância {{ $labels.instance }} tem mais de 10.000 conexões TCP estabelecidas (atual: {{ $value }})."
          dashboard: "http://localhost:3000/d/node_exporter_full?var-instance={{ $labels.instance }}"
